<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secure Document Upload | Bill Layne Insurance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#1a5f7a; --secondary:#457b9d; --accent:#a8dadc; --bg:#f8f9fa; --text:#2c3e50; --radius:12px; --shadow:0 8px 30px rgba(0,0,0,.08) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Arial,sans-serif}
  header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center;padding:18px 14px;box-shadow:var(--shadow)}
  .title{font-size:1.5rem;font-weight:700}
  .wrap{max-width:800px;margin:18px auto;padding:0 12px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  label{font-size:.9rem;margin-bottom:6px;display:block;font-weight:600}
  input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:1rem;background:#fff}
  input:focus{border-color:var(--secondary);box-shadow:0 0 0 3px rgba(69,123,157,.12);outline:none}
  .btn{border:0;border-radius:999px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn-primary{background:linear-gradient(135deg,var(--secondary),var(--primary));color:#fff}
  .btn-ghost{background:#edf2f7;color:var(--text)}
  .row{display:grid;gap:10px}
  @media(min-width:700px){ .row-2{grid-template-columns:2fr 1fr} }
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:.8rem;background:var(--accent);color:#0b3a4a;margin:3px 6px 0 0;font-weight:700}
  .muted{opacity:.75}
  .upload-box{border:1.5px dashed #c7dfe6;border-radius:12px;padding:12px;background:#fbfeff}
  .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .left{display:flex;gap:8px;flex-wrap:wrap}
  .list{margin:8px 0;display:flex;flex-wrap:wrap;gap:6px}
  .ok{color:#0a7a3a;font-weight:700}
  .pending{color:#b45309;font-weight:700}
  .footer{padding:20px;text-align:center;color:#38505c}
  .hint{font-size:.85rem;opacity:.8;margin-top:6px}
  @media print {.btn,.upload-box{display:none !important} .card{box-shadow:none;border:1px solid #e5e7eb}}

  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal .box{ width:min(520px,90vw); background:#fff; border-radius:12px; box-shadow:var(--shadow); padding:18px; text-align:center; }
  .bar-wrap{width:100%; background:#eef2f6; border-radius:999px; height:12px; margin:10px 0 6px 0; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--secondary), var(--primary))}
  .small{font-size:.9rem; opacity:.8}
</style>
</head>
<body>
<header>
  <div class="title">Secure Document Upload</div>
  <div>Bill Layne Insurance</div>
</header>

<div class="wrap">
  <!-- Find Case -->
  <section class="card">
    <h3 style="margin:4px 0 10px 0">Find Your Case</h3>
    <div class="row row-2">
      <div>
        <label>Case ID <span class="muted">(from our email)</span></label>
        <input id="caseId" placeholder="e.g., 7F3A2C91" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindById">Open</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label>Or search by your email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindByEmail">Search</button>
      </div>
    </div>
    <div id="findMsg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Case Summary -->
  <section class="card" id="caseCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Your Case</h3>
    <div id="who" class="muted"></div>
    <div id="tags" class="list"></div>
    <div style="margin-top:6px"><strong>Status:</strong> <span id="status" class="pending">Pending</span></div>
    <div class="muted" style="margin-top:6px">Items we may still need are shown below. You can upload files securely.</div>
  </section>

  <!-- Outstanding items -->
  <section class="card" id="needCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Requested Items</h3>
    <div id="needList" class="list"></div>
  </section>

  <!-- Upload -->
  <section class="card" id="uploadCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Upload Documents</h3>
    <div class="upload-box">
      <label>Attach files (PDF, JPG, PNG) or take photos</label>

      <input id="fFiles" type="file" multiple accept=".pdf,image/*" />
      <input id="fCamera" type="file" accept="image/*" capture="environment" multiple style="display:none" />

      <div class="left" style="margin-top:10px">
        <button class="btn btn-ghost" id="btnOpenFiles">Choose from device</button>
        <button class="btn btn-primary" id="btnOpenCamera">Take Photo</button>
        <button class="btn btn-primary" id="btnUpload">Upload</button>
      </div>
      <div class="hint">Please wait for confirmation after pressing Upload. Don’t close this page until you see “All files uploaded”.</div>
    </div>
    <div id="filesMsg" class="muted" style="margin-top:6px"></div>
    <div id="filesList" class="list"></div>
  </section>
</div>

<!-- Upload modal -->
<div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-live="assertive">
  <div class="box">
    <div style="font-weight:800; font-size:1.1rem">Uploading… please wait</div>
    <div id="modalLine" class="small" style="margin-top:6px">Preparing</div>
    <div class="bar-wrap"><div id="modalBar" class="bar"></div></div>
    <div id="modalHint" class="small">Do not close this page until confirmation.</div>
  </div>
</div>

<div class="footer">
  © Bill Layne Insurance • 336-835-1993 • <a href="https://www.BillLayneInsurance.com" target="_blank">BillLayneInsurance.com</a>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby-9vCxMW1wtbKL_Q2i0TRSyFiTODCg_eTINdwC8Y55QjjL2Jm2MZSeaycfDLEXpOhjjA/exec";

let CASE_ID = "";
let REQUIREMENTS = [];
let REQ_STATUS = {};
let pendingFiles = [];
let isUploading = false;

/* --- helpers --- */
async function postForm(data){
  const fd = new FormData();
  Object.entries(data).forEach(([k,v])=>{
    if (v instanceof File || v instanceof Blob) fd.append(k,v);
    else if (Array.isArray(v)) fd.append(k, JSON.stringify(v));
    else fd.append(k, v ?? "");
  });
  const res = await fetch(API_URL, { method:"POST", body: fd, redirect:"follow" });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return {ok:false,error:txt.slice(0,300)}; }
}
function el(id){return document.getElementById(id)}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function showModal(){ el("uploadModal").style.display = "flex"; }
function hideModal(){ el("uploadModal").style.display = "none"; }
function setModal(line, pct){ el("modalLine").textContent = line; el("modalBar").style.width = `${Math.max(0, Math.min(100, pct))}%`; }

/* --- UI --- */
function renderCase(d){
  CASE_ID = d.caseId;
  REQUIREMENTS = d.requirements || [];
  REQ_STATUS = d.reqStatus || {};

  el("caseCard").style.display = "";
  el("needCard").style.display = "";
  el("uploadCard").style.display = "";

  el("who").innerHTML = `${esc(d.name||"Customer")} • ${esc(d.product||"")} ${d.company?("• "+esc(d.company)):""} • Case <strong>${esc(CASE_ID)}</strong>`;
  el("status").textContent = d.status || "Pending";
  el("status").className = d.status==="Complete" ? "ok" : "pending";

  const tags = REQUIREMENTS.map(r=>`<span class="pill">${REQ_STATUS[r.key]===true?"✅ ":"⏳ "}${esc(r.label)}</span>`).join("");
  el("tags").innerHTML = tags;

  const outstanding = REQUIREMENTS.filter(r => REQ_STATUS[r.key]!==true);
  el("needList").innerHTML = outstanding.length ? outstanding.map(r=>`<span class="pill">${esc(r.label)}</span>`).join("") : `<span class="ok">You’re all set — nothing outstanding.</span>`;

  // refresh files list
  const again = { files: d.files || [] };
  renderFiles(again.files);
}
function renderFiles(files){
  el("filesList").innerHTML = (!files || !files.length) ? `<span class="muted">No files uploaded yet.</span>` : files.map(f=>`<a class="pill" href="${f.url}" target="_blank">${esc(f.name)}</a>`).join("");
}

/* --- optional image downscale --- */
async function maybeDownscale(file, maxDim=2000, quality=0.85){
  if (!file.type.startsWith('image/')) return file;
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      let w = img.width, h = img.height;
      if (Math.max(w,h) <= maxDim) { resolve(file); return; }
      const scale = maxDim / Math.max(w,h);
      w = Math.round(w*scale); h = Math.round(h*scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      canvas.toBlob((blob)=>{
        if (!blob) { resolve(file); return; }
        const renamed = new File([blob], (file.name||'photo').replace(/\.(heic|heif)$/i,'.jpg').replace(/\.(jpeg|jpg|png|webp)?$/i,'.jpg'), { type:'image/jpeg' });
        resolve(renamed);
      }, 'image/jpeg', quality);
    };
    img.onerror = ()=> resolve(file);
    img.src = URL.createObjectURL(file);
  });
}

/* --- XHR upload with long timeout + retries --- */
function xhrUploadSingle(file, caseId, onProgress, timeoutMs=300000){ // 5 min
  return new Promise((resolve, reject)=>{
    const fd = new FormData();
    fd.append("action","upload");
    fd.append("caseId", caseId);
    fd.append("files", file, file.name);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", API_URL);
    xhr.timeout = timeoutMs;
    xhr.upload.onprogress = (e)=>{
      if (e.lengthComputable && typeof onProgress === 'function'){
        const pct = Math.round((e.loaded / e.total) * 100);
        onProgress(pct);
      }
    };
    xhr.onerror = ()=> reject(new Error("Network error"));
    xhr.ontimeout = ()=> reject(new Error("Upload timed out"));
    xhr.onload = ()=>{
      if (xhr.status >= 200 && xhr.status < 300){
        try { resolve(JSON.parse(xhr.responseText)); }
        catch { reject(new Error("Invalid server response")); }
      } else {
        reject(new Error(`HTTP ${xhr.status}`));
      }
    };
    xhr.send(fd);
  });
}
async function uploadWithRetry(file, caseIdx, total, attempt=1){
  const maxAttempts = 3;
  try{
    setModal(`Uploading ${file.name} (${caseIdx}/${total})`, 0);
    const res = await xhrUploadSingle(file, CASE_ID, (pct)=>{
      const base = ((caseIdx-1)/total)*100;
      const spread = (1/total)*pct;
      setModal(`Uploading ${file.name} (${caseIdx}/${total}) — ${pct}%`, Math.min(99, base + spread));
    });
    if(!res.ok) throw new Error(res.error || "Server error");
    return res;
  }catch(err){
    if (attempt < maxAttempts){
      const backoff = Math.pow(2, attempt) * 1000; // 2s, 4s
      setModal(`Retrying ${file.name}… (attempt ${attempt+1}/${maxAttempts})`, 0);
      await new Promise(r=>setTimeout(r, backoff));
      return uploadWithRetry(file, caseIdx, total, attempt+1);
    }
    throw err;
  }
}

/* --- Actions --- */
async function openById(){
  const id = el("caseId").value.trim();
  if(!id){ el("findMsg").textContent = "Enter your Case ID."; return; }
  el("findMsg").textContent = "Loading…";
  const r = await postForm({action:"loadById", caseId:id});
  if(!r.ok){ el("findMsg").textContent = "Case not found."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#case="+encodeURIComponent(id));
}
async function openByEmail(){
  const email = el("email").value.trim();
  if(!email){ el("findMsg").textContent = "Enter your email."; return; }
  el("findMsg").textContent = "Searching…";
  const r = await postForm({action:"loadByEmail", email});
  if(!r.ok){ el("findMsg").textContent = "No case found for that email."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#email="+encodeURIComponent(email));
}
function queueFiles(fileList){
  for(const f of fileList){ pendingFiles.push(f); }
  el("filesMsg").textContent = pendingFiles.length ? `${pendingFiles.length} file(s) ready to upload.` : "";
}
async function uploadFiles(){
  if(!CASE_ID){ el("filesMsg").textContent = "Open your case first."; return; }
  if(!pendingFiles.length){ el("filesMsg").textContent = "Choose or take a photo first."; return; }

  isUploading = true;
  const onBeforeUnload = (e)=>{ e.preventDefault(); e.returnValue = ""; };
  window.addEventListener("beforeunload", onBeforeUnload);
  setButtonsDisabled(true);

  try{
    showModal();
    setModal("Optimizing photos…", 0);

    const prepared = [];
    for (const f of pendingFiles){ prepared.push(await maybeDownscale(f)); }

    const total = prepared.length;
    let idx = 1;
    for (const f of prepared){ await uploadWithRetry(f, idx, total); idx++; }

    const again = await postForm({action:"loadById", caseId: CASE_ID});
    if (again.ok){ renderFiles(again.files||[]); }

    setModal("All files uploaded ✔", 100);
    el("filesMsg").textContent = "All files uploaded. Thank you!";
  }catch(err){
    el("filesMsg").textContent = "Upload failed – please try again. Details: " + (err?.message || err);
    setModal("Upload failed. You can close this and retry.", 0);
  }finally{
    window.removeEventListener("beforeunload", onBeforeUnload);
    isUploading = false;
    setButtonsDisabled(false);
    el("fFiles").value = "";
    el("fCamera").value = "";
    pendingFiles = [];
    setTimeout(()=> hideModal(), 1200);
  }
}
function setButtonsDisabled(disabled){
  ["btnOpenFiles","btnOpenCamera","btnUpload","btnFindById","btnFindByEmail"].forEach(id=>{
    const b = el(id); if (b) b.disabled = disabled;
  });
}

/* --- Deep link --- */
function parseHash(){
  const h = location.hash || "";
  const mEmail = h.match(/email=([^&]+)/);
  const mCase  = h.match(/case=([^&]+)/);
  return { email: mEmail ? decodeURIComponent(mEmail[1]) : "", caseId: mCase ? decodeURIComponent(mCase[1]) : "" };
}
window.addEventListener("load", async ()=>{
  const { email, caseId } = parseHash();
  if(email){ el("email").value = email; openByEmail(); }
  else if(caseId){ el("caseId").value = caseId; openById(); }
});

/* --- Events --- */
el("btnFindById").addEventListener("click", openById);
el("btnFindByEmail").addEventListener("click", openByEmail);
el("btnOpenFiles").addEventListener("click", ()=> el("fFiles").click());
el("fFiles").addEventListener("change", (e)=> queueFiles(e.target.files));
el("btnOpenCamera").addEventListener("click", ()=> el("fCamera").click());
el("fCamera").addEventListener("change", (e)=> queueFiles(e.target.files));
el("btnUpload").addEventListener("click", uploadFiles);
</script>
</body>
</html>


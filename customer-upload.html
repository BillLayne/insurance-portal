<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secure Document Upload | Bill Layne Insurance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#1a5f7a; --secondary:#457b9d; --accent:#a8dadc; --bg:#f8f9fa; --text:#2c3e50; --radius:12px; --shadow:0 8px 30px rgba(0,0,0,.08) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Arial,sans-serif}
  header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center;padding:18px 14px;box-shadow:var(--shadow)}
  .title{font-size:1.5rem;font-weight:700}
  .wrap{max-width:800px;margin:18px auto;padding:0 12px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  label{font-size:.9rem;margin-bottom:6px;display:block;font-weight:600}
  input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:1rem;background:#fff}
  input:focus{border-color:var(--secondary);box-shadow:0 0 0 3px rgba(69,123,157,.12);outline:none}
  .btn{border:0;border-radius:999px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn-primary{background:linear-gradient(135deg,var(--secondary),var(--primary));color:#fff}
  .btn-ghost{background:#edf2f7;color:var(--text)}
  .row{display:grid;gap:10px}
  @media(min-width:700px){ .row-2{grid-template-columns:2fr 1fr} }
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:.8rem;background:var(--accent);color:#0b3a4a;margin:3px 6px 0 0;font-weight:700}
  .muted{opacity:.75}
  .upload-box{border:1.5px dashed #c7dfe6;border-radius:12px;padding:12px;background:#fbfeff}
  .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .left{display:flex;gap:8px;flex-wrap:wrap}
  .list{margin:8px 0;display:flex;flex-wrap:wrap;gap:6px}
  .ok{color:#0a7a3a;font-weight:700}
  .pending{color:#b45309;font-weight:700}
  .footer{padding:20px;text-align:center;color:#38505c}
  .hint{font-size:.85rem;opacity:.8;margin-top:6px}
  @media print {.btn,.upload-box{display:none !important} .card{box-shadow:none;border:1px solid #e5e7eb}}

  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal .box{ width:min(520px,90vw); background:#fff; border-radius:12px; box-shadow:var(--shadow); padding:18px; text-align:center; }
  .bar-wrap{width:100%; background:#eef2f6; border-radius:999px; height:12px; margin:10px 0 6px 0; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--secondary), var(--primary))}
  .small{font-size:.9rem; opacity:.8}
</style>
</head>
<body>
<header>
  <div class="title">Secure Document Upload</div>
  <div>Bill Layne Insurance</div>
</header>

<div class="wrap">
  <!-- Find Case -->
  <section class="card">
    <h3 style="margin:4px 0 10px 0">Find Your Case</h3>
    <div class="row row-2">
      <div>
        <label>Case ID <span class="muted">(from our email)</span></label>
        <input id="caseId" placeholder="e.g., 7F3A2C91" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindById">Open</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label>Or search by your email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindByEmail">Search</button>
      </div>
    </div>
    <div id="findMsg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Case Summary -->
  <section class="card" id="caseCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Your Case</h3>
    <div id="who" class="muted"></div>
    <div id="tags" class="list"></div>
    <div style="margin-top:6px"><strong>Status:</strong> <span id="status" class="pending">Pending</span></div>
    <div class="muted" style="margin-top:6px">Items we may still need are shown below. You can upload files securely.</div>
  </section>

  <!-- Outstanding items -->
  <section class="card" id="needCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Requested Items</h3>
    <div id="needList" class="list"></div>
  </section>

  <!-- Upload -->
  <section class="card" id="uploadCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Upload Documents</h3>
    <div class="upload-box">
      <label>Attach files (PDF, JPG, PNG) or take photos</label>

      <!-- Single visible inputs; we’ll POST via fetch({mode:'no-cors'}) -->
      <input id="fFiles" type="file" multiple accept=".pdf,image/*" />
      <input id="fCamera" type="file" accept="image/*" capture="environment" multiple style="display:none" />

      <div class="left" style="margin-top:10px">
        <button class="btn btn-ghost" id="btnOpenFiles">Choose from device</button>
        <button class="btn btn-primary" id="btnOpenCamera">Take Photo</button>
        <button class="btn btn-primary" id="btnUpload">Upload</button>
      </div>
      <div class="hint">Please wait for confirmation after pressing Upload. Don’t close this page until you see “All files uploaded”.</div>
    </div>
    <div id="filesMsg" class="muted" style="margin-top:6px"></div>
    <div id="filesList" class="list"></div>
  </section>
</div>

<!-- Upload modal -->
<div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-live="assertive">
  <div class="box">
    <div style="font-weight:800; font-size:1.1rem">Uploading… please wait</div>
    <div id="modalLine" class="small" style="margin-top:6px">Preparing</div>
    <div class="bar-wrap"><div id="modalBar" class="bar"></div></div>
    <div id="modalHint" class="small">Do not close this page until confirmation.</div>
  </div>
</div>

<div class="footer">
  © Bill Layne Insurance • 336-835-1993 • <a href="https://www.BillLayneInsurance.com" target="_blank">BillLayneInsurance.com</a>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby-9vCxMW1wtbKL_Q2i0TRSyFiTODCg_eTINdwC8Y55QjjL2Jm2MZSeaycfDLEXpOhjjA/exec";

let CASE_ID = "";
let REQUIREMENTS = [];
let REQ_STATUS = {};
let filesCount = 0;

/* --- helpers --- */
function el(id){return document.getElementById(id)}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function showModal(){ el("uploadModal").style.display = "flex"; }
function hideModal(){ el("uploadModal").style.display = "none"; }
function setModal(line, pct){ el("modalLine").textContent = line; el("modalBar").style.width = `${Math.max(0, Math.min(100, pct))}%`; }

/* JSONP loader (bypasses CORS for reads) */
function jsonp(url){
  return new Promise((resolve)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ try{ resolve(data);} finally{ delete window[cb]; s.remove(); } };
    const s = document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror = ()=>{ resolve({ok:false,error:'jsonp_error'}); s.remove(); delete window[cb]; };
    document.body.appendChild(s);
  });
}

/* --- UI --- */
function renderCase(d){
  CASE_ID = d.caseId;
  REQUIREMENTS = d.requirements || [];
  REQ_STATUS = d.reqStatus || {};
  filesCount = (d.files||[]).length;

  el("caseCard").style.display = "";
  el("needCard").style.display = "";
  el("uploadCard").style.display = "";

  el("who").innerHTML = `${esc(d.name||"Customer")} • ${esc(d.product||"")} ${d.company?("• "+esc(d.company)):""} • Case <strong>${esc(CASE_ID)}</strong>`;
  el("status").textContent = d.status || "Pending";
  el("status").className = d.status==="Complete" ? "ok" : "pending";

  const tags = REQUIREMENTS.map(r=>`<span class="pill">${REQ_STATUS[r.key]===true?"✅ ":"⏳ "}${esc(r.label)}</span>`).join("");
  el("tags").innerHTML = tags;

  const outstanding = REQUIREMENTS.filter(r => REQ_STATUS[r.key]!==true);
  el("needList").innerHTML = outstanding.length ? outstanding.map(r=>`<span class="pill">${esc(r.label)}</span>`).join("") : `<span class="ok">You’re all set — nothing outstanding.</span>`;

  renderFiles(d.files||[]);
}
function renderFiles(files){
  el("filesList").innerHTML = (!files || !files.length) ? `<span class="muted">No files uploaded yet.</span>` : files.map(f=>`<a class="pill" href="${f.url}" target="_blank">${esc(f.name)}</a>`).join("");
}

/* --- Actions (reads via JSONP) --- */
async function openById(){
  const id = el("caseId").value.trim();
  if(!id){ el("findMsg").textContent = "Enter your Case ID."; return; }
  el("findMsg").textContent = "Loading…";
  const r = await jsonp(`${API_URL}?action=loadById&caseId=${encodeURIComponent(id)}`);
  if(!r.ok){ el("findMsg").textContent = "Case not found."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#case="+encodeURIComponent(id));
}
async function openByEmail(){
  const email = el("email").value.trim();
  if(!email){ el("findMsg").textContent = "Enter your email."; return; }
  el("findMsg").textContent = "Searching…";
  const r = await jsonp(`${API_URL}?action=loadByEmail&email=${encodeURIComponent(email)}`);
  if(!r.ok){ el("findMsg").textContent = "No case found for that email."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#email="+encodeURIComponent(email));
}

/* --- Upload via fetch no-cors, then confirm via JSONP poll --- */
async function uploadFiles(){
  if(!CASE_ID){ el("filesMsg").textContent = "Open your case first."; return; }
  const picks = [];
  if (el("fFiles").files.length) picks.push(...el("fFiles").files);
  if (el("fCamera").files.length) picks.push(...el("fCamera").files);
  if (!picks.length){ el("filesMsg").textContent = "Choose or take a photo first."; return; }

  // Build FormData: IMPORTANT — use 'file' repeated (Apps Script will expose file, file_1, file_2…)
  const fd = new FormData();
  fd.append("action","upload");
  fd.append("caseId", CASE_ID);
  picks.forEach((f, i)=> fd.append("file", f, f.name));

  showModal();
  setModal("Uploading… please wait", 40);
  el("filesMsg").textContent = "Uploading… please wait";

  // Fire-and-forget: opaque response, no CORS needed
  try{
    await fetch(API_URL, { method:"POST", body: fd, mode: "no-cors" });
  }catch(_){ /* ignore — we’ll verify by polling */ }

  // Poll until Files count increases (server write confirmed)
  setModal("Processing files…", 70);
  const ok = await pollForNewFiles(120000); // up to 2 minutes
  if (ok){
    setModal("All files uploaded ✔", 100);
    el("filesMsg").textContent = "All files uploaded. Thank you!";
  }else{
    el("filesMsg").textContent = "Upload submitted, but confirmation timed out. Please try again if you don’t see your file(s) above.";
    setModal("Confirmation timed out — you may retry.", 0);
  }
  setTimeout(hideModal, 1200);
  el("fFiles").value = ""; el("fCamera").value = "";
}
async function pollForNewFiles(maxMs){
  const start = Date.now();
  let tries = 0;
  while(Date.now() - start < maxMs){
    await new Promise(r=>setTimeout(r, 1500));
    tries++;
    const r = await jsonp(`${API_URL}?action=loadById&caseId=${encodeURIComponent(CASE_ID)}`);
    if(r.ok){
      renderFiles(r.files||[]);
      if ((r.files||[]).length > filesCount){ filesCount = (r.files||[]).length; return true; }
    }
    setModal(`Processing files… (check ${tries})`, Math.min(95, 70 + tries*2));
  }
  return false;
}

/* --- Deep link --- */
function parseHash(){
  const h = location.hash || "";
  const mEmail = h.match(/email=([^&]+)/);
  const mCase  = h.match(/case=([^&]+)/);
  return { email: mEmail ? decodeURIComponent(mEmail[1]) : "", caseId: mCase ? decodeURIComponent(mCase[1]) : "" };
}
window.addEventListener("load", async ()=>{
  const { email, caseId } = parseHash();
  if(email){ el("email").value = email; openByEmail(); }
  else if(caseId){ el("caseId").value = caseId; openById(); }
});

/* --- Events --- */
el("btnFindById").addEventListener("click", openById);
el("btnFindByEmail").addEventListener("click", openByEmail);
el("btnOpenFiles").addEventListener("click", ()=> el("fFiles").click());
el("btnOpenCamera").addEventListener("click", ()=> el("fCamera").click());
el("btnUpload").addEventListener("click", uploadFiles);
</script>
</body>
</html>

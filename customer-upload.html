<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secure Document Upload | Bill Layne Insurance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* =============== PROFESSIONAL INSURANCE THEME =============== */
  :root {
    /* Professional Color Palette - Matching Admin */
    --primary: #003d7a;        /* Deep Trust Blue */
    --primary-dark: #002855;    /* Darker Blue */
    --secondary: #0066cc;       /* Bright Action Blue */
    --accent: #00a6fb;          /* Sky Blue Accent */
    --success: #00c896;         /* Success Green */
    --warning: #ffb413;         /* Warning Amber */
    --danger: #ff4757;          /* Alert Red */
    
    /* Neutral Colors */
    --gray-900: #1a202c;
    --gray-800: #2d3748;
    --gray-700: #4a5568;
    --gray-600: #718096;
    --gray-500: #a0aec0;
    --gray-400: #cbd5e0;
    --gray-300: #e2e8f0;
    --gray-200: #edf2f7;
    --gray-100: #f7fafc;
    --white: #ffffff;
    
    /* Shadows & Effects */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    /* Borders & Radius */
    --radius-sm: 0.375rem;
    --radius: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --border-color: #e2e8f0;
    
    /* Transitions */
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* =============== RESET & BASE =============== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--gray-900);
    background: linear-gradient(135deg, #f5f7fa 0%, #f0f4f8 100%);
    line-height: 1.6;
    min-height: 100vh;
  }
  
  /* =============== HEADER - CUSTOMER FRIENDLY =============== */
  header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: var(--white);
    padding: 1.5rem 0;
    text-align: center;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }
  
  header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 50px 50px;
    animation: moveGrid 20s linear infinite;
    opacity: 0.3;
  }
  
  @keyframes moveGrid {
    0% { transform: translate(0, 0); }
    100% { transform: translate(50px, 50px); }
  }
  
  .header-content {
    position: relative;
    z-index: 1;
  }
  
  .security-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.375rem 0.875rem;
    border-radius: 999px;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .security-badge::before {
    content: 'üîí';
    font-size: 1rem;
  }
  
  .title {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-family: 'Plus Jakarta Sans', sans-serif;
    letter-spacing: -0.025em;
  }
  
  .subtitle {
    font-size: 1rem;
    opacity: 0.95;
    font-weight: 400;
  }
  
  /* =============== CONTAINER =============== */
  .wrap {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }
  
  /* =============== CARDS - ELEVATED DESIGN =============== */
  .card {
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-color);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    animation: slideUp 0.4s ease-out;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  
  .card:hover::before {
    transform: scaleX(1);
  }
  
  .card h3 {
    color: var(--gray-900);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }
  
  .card h3::before {
    content: '';
    width: 4px;
    height: 24px;
    background: linear-gradient(180deg, var(--primary), var(--accent));
    border-radius: 2px;
  }
  
  /* =============== STATUS CARD VARIATIONS =============== */
  #caseCard {
    background: linear-gradient(135deg, var(--white) 0%, #f8fbff 100%);
    border-left: 4px solid var(--primary);
  }
  
  #needCard {
    background: linear-gradient(135deg, var(--white) 0%, #fffbf5 100%);
    border-left: 4px solid var(--warning);
  }
  
  #uploadCard {
    background: linear-gradient(135deg, var(--white) 0%, #f5fff9 100%);
    border-left: 4px solid var(--success);
  }
  
  /* =============== FORM ELEMENTS =============== */
  label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid var(--gray-300);
    border-radius: var(--radius);
    font-size: 1rem;
    background: var(--white);
    transition: var(--transition);
    font-family: 'Inter', sans-serif;
  }
  
  input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 61, 122, 0.1);
    background: var(--gray-100);
    transform: translateY(-1px);
  }
  
  input:hover {
    border-color: var(--gray-400);
  }
  
  input[type="file"] {
    padding: 0.75rem;
    cursor: pointer;
  }
  
  /* =============== BUTTONS - PREMIUM STYLE =============== */
  .btn {
    border: none;
    border-radius: var(--radius);
    padding: 0.875rem 1.75rem;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: var(--transition);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    position: relative;
    overflow: hidden;
    font-family: 'Plus Jakarta Sans', sans-serif;
    white-space: nowrap;
  }
  
  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s, height 0.3s;
  }
  
  .btn:hover::before {
    width: 300px;
    height: 300px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: var(--white);
    box-shadow: var(--shadow-md);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  
  .btn-ghost {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 2px solid var(--gray-300);
  }
  
  .btn-ghost:hover {
    background: var(--gray-200);
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-1px);
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  
  /* =============== GRID LAYOUTS =============== */
  .row {
    display: grid;
    gap: 1rem;
  }
  
  .row-2 {
    grid-template-columns: 1fr;
  }
  
  @media (min-width: 640px) {
    .row-2 {
      grid-template-columns: 2fr 1fr;
    }
  }
  
  /* =============== STATUS & PILLS =============== */
  .pill {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0.25rem;
    background: linear-gradient(135deg, var(--accent), var(--secondary));
    color: var(--white);
    box-shadow: var(--shadow-sm);
    letter-spacing: 0.025em;
    transition: var(--transition);
  }
  
  .pill:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  /* File pills with links */
  a.pill {
    text-decoration: none;
    background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
    color: var(--primary);
    border: 1px solid var(--gray-300);
  }
  
  a.pill:hover {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: var(--white);
    border-color: var(--primary);
  }
  
  /* =============== STATUS INDICATORS =============== */
  .ok {
    color: var(--success);
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(0, 200, 150, 0.1);
    border-radius: var(--radius);
    border: 1px solid rgba(0, 200, 150, 0.3);
  }
  
  .ok::before {
    content: '‚úÖ';
    font-size: 1.25rem;
  }
  
  .pending {
    color: var(--warning);
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 180, 19, 0.1);
    border-radius: var(--radius);
    border: 1px solid rgba(255, 180, 19, 0.3);
  }
  
  .pending::before {
    content: '‚è≥';
    font-size: 1.25rem;
  }
  
  /* =============== UPLOAD BOX - INTERACTIVE =============== */
  .upload-box {
    border: 3px dashed var(--gray-400);
    border-radius: var(--radius-lg);
    padding: 2.5rem 1.5rem;
    background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
    text-align: center;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }
  
  .upload-box::before {
    content: 'üìÑ';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 5rem;
    opacity: 0.05;
    transition: var(--transition);
  }
  
  .upload-box:hover {
    border-color: var(--primary);
    background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
    transform: scale(1.02);
  }
  
  .upload-box:hover::before {
    opacity: 0.1;
    transform: translate(-50%, -50%) rotate(10deg) scale(1.1);
  }
  
  /* =============== FILE PREVIEW =============== */
  .file-preview {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, var(--white) 0%, var(--gray-100) 100%);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    margin-top: 0.75rem;
    transition: var(--transition);
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  .file-preview:hover {
    box-shadow: var(--shadow-md);
    transform: translateX(5px);
  }
  
  .file-preview .name {
    flex: 1;
    font-weight: 500;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .file-preview .name::before {
    content: 'üìé';
  }
  
  .file-preview .size {
    font-size: 0.875rem;
    color: var(--gray-600);
    background: var(--gray-200);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
  }
  
  .file-preview .remove {
    background: linear-gradient(135deg, var(--danger), #e63946);
    color: var(--white);
    border: none;
    padding: 0.375rem 0.875rem;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: var(--transition);
  }
  
  .file-preview .remove:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
  }
  
  /* =============== MODAL - PREMIUM =============== */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal .box {
    width: min(500px, 90vw);
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    padding: 2rem;
    text-align: center;
    animation: modalSlide 0.3s ease-out;
    border: 3px solid var(--primary);
  }
  
  @keyframes modalSlide {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  .modal .box::before {
    content: '‚¨ÜÔ∏è';
    display: block;
    font-size: 3rem;
    margin-bottom: 1rem;
    animation: bounce 1s ease-in-out infinite;
  }
  
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  
  .bar-wrap {
    width: 100%;
    background: var(--gray-200);
    border-radius: 999px;
    height: 16px;
    margin: 1rem 0;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transition: width 0.3s ease;
    border-radius: 999px;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }
  
  .bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
  }
  
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  
  /* =============== UTILITY CLASSES =============== */
  .muted {
    opacity: 0.7;
    color: var(--gray-600);
    font-style: italic;
  }
  
  .hint {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: var(--gray-100);
    border-radius: var(--radius);
    border-left: 3px solid var(--primary);
  }
  
  .right {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .left {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .list {
    margin: 1rem 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .success-msg {
    background: linear-gradient(135deg, rgba(0, 200, 150, 0.1), rgba(0, 200, 150, 0.05));
    border: 2px solid var(--success);
    color: var(--success);
    padding: 1rem;
    border-radius: var(--radius);
    margin-top: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: successPulse 0.5s ease-out;
  }
  
  @keyframes successPulse {
    0% { transform: scale(0.95); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }
  
  .success-msg::before {
    content: '‚úÖ';
    font-size: 1.5rem;
  }
  
  /* =============== FOOTER - PROFESSIONAL =============== */
  .footer {
    margin-top: 4rem;
    padding: 2rem;
    background: linear-gradient(135deg, var(--gray-900), var(--gray-800));
    color: var(--white);
    text-align: center;
    font-size: 0.9rem;
    box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
  }
  
  .footer a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
  }
  
  .footer a:hover {
    color: var(--white);
    text-decoration: underline;
  }
  
  /* =============== TRUST INDICATORS =============== */
  .trust-badges {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--gray-100), var(--white));
    border-radius: var(--radius-lg);
    flex-wrap: wrap;
  }
  
  .trust-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-700);
  }
  
  .trust-badge::before {
    font-size: 2rem;
  }
  
  .trust-badge:nth-child(1)::before { content: 'üîí'; }
  .trust-badge:nth-child(2)::before { content: '‚úÖ'; }
  .trust-badge:nth-child(3)::before { content: 'üèÜ'; }
  
  /* =============== RESPONSIVE DESIGN =============== */
  @media (max-width: 640px) {
    .title {
      font-size: 1.5rem;
    }
    
    .card {
      padding: 1.25rem;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
      padding: 0.875rem 1rem;
    }
    
    .upload-box {
      padding: 1.5rem 1rem;
    }
    
    .pill {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
  }
  
  /* =============== PRINT STYLES =============== */
  @media print {
    .btn, .upload-box {
      display: none !important;
    }
    
    body {
      background: var(--white);
    }
    
    .card {
      box-shadow: none;
      border: 1px solid var(--gray-400);
      page-break-inside: avoid;
    }
    
    header {
      position: static;
      box-shadow: none;
    }
  }
  
  /* =============== ACCESSIBILITY =============== */
  *:focus-visible {
    outline: 3px solid var(--accent);
    outline-offset: 2px;
  }
  
  .small {
    font-size: 0.875rem;
    color: var(--gray-600);
  }
</style>
</head>
<body>
<!-- PREMIUM HEADER WITH SECURITY BADGE -->
<header>
  <div class="header-content">
    <div class="security-badge">256-bit SSL Encrypted</div>
    <div class="title">Secure Document Upload</div>
    <div class="subtitle">Bill Layne Insurance Agency</div>
  </div>
</header>

<div class="wrap">
  <!-- TRUST INDICATORS -->
  <div class="trust-badges">
    <div class="trust-badge">
      <strong>Secure Upload</strong>
      <span>Your files are encrypted</span>
    </div>
    <div class="trust-badge">
      <strong>Verified Agency</strong>
      <span>Licensed & Insured</span>
    </div>
    <div class="trust-badge">
      <strong>Fast Processing</strong>
      <span>Documents reviewed quickly</span>
    </div>
  </div>

  <!-- ALL YOUR ORIGINAL HTML CONTENT BELOW - NO FUNCTIONALITY CHANGES -->
  
  <!-- Find Case -->
  <section class="card">
    <h3>Find Your Case</h3>
    <div class="row row-2">
      <div>
        <label>Case ID <span class="muted">(from our email)</span></label>
        <input id="caseId" placeholder="e.g., 7F3A2C91" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindById">Open Case</button>
      </div>
    </div>
    <div class="row" style="margin-top:1rem">
      <div>
        <label>Or search by your email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindByEmail">Find My Case</button>
      </div>
    </div>
    <div id="findMsg" class="muted" style="margin-top:1rem"></div>
  </section>

  <!-- Case Summary -->
  <section class="card" id="caseCard" style="display:none">
    <h3>Your Insurance Case</h3>
    <div id="who" class="muted"></div>
    <div id="tags" class="list"></div>
    <div style="margin-top:1rem"><strong>Status:</strong> <span id="status" class="pending">Pending</span></div>
    <div class="muted" style="margin-top:0.75rem">Items we may still need are shown below. You can upload files securely.</div>
  </section>

  <!-- Outstanding items -->
  <section class="card" id="needCard" style="display:none">
    <h3>Requested Documents</h3>
    <div id="needList" class="list"></div>
    <div class="hint">Please upload clear photos or PDFs of the requested documents. All uploads are secure and encrypted.</div>
  </section>

  <!-- Upload -->
  <section class="card" id="uploadCard" style="display:none">
    <h3>Upload Your Documents</h3>
    <div class="upload-box">
      <label style="font-size:1rem; text-transform:none;">Select files to upload (PDF, JPG, PNG)</label>
      
      <!-- File inputs -->
      <input id="fFiles" type="file" multiple accept=".pdf,image/*" style="margin:1rem 0" />
      <input id="fCamera" type="file" accept="image/*" capture="environment" multiple style="display:none" />

      <!-- File preview area -->
      <div id="filePreviewArea"></div>

      <div class="left" style="margin-top:1.5rem; justify-content:center">
        <button class="btn btn-ghost" id="btnOpenFiles">üìÅ Choose Files</button>
        <button class="btn btn-primary" id="btnOpenCamera">üì∏ Take Photo</button>
      </div>
      <div style="margin-top:1rem">
        <button class="btn btn-primary" id="btnUpload" disabled style="width:100%; max-width:300px">Upload Selected Files</button>
      </div>
      <div class="hint">Maximum file size: 10MB per file ‚Ä¢ Your uploads are encrypted and secure</div>
    </div>
    <div id="filesMsg" class="muted" style="margin-top:1rem"></div>
    <div id="filesList" class="list"></div>
  </section>
</div>

<!-- Upload modal -->
<div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-live="assertive">
  <div class="box">
    <div style="font-weight:800; font-size:1.25rem; color:var(--primary); margin-bottom:1rem">Uploading Your Documents</div>
    <div id="modalLine" class="small" style="margin-bottom:1rem">Preparing secure upload...</div>
    <div class="bar-wrap"><div id="modalBar" class="bar"></div></div>
    <div id="modalHint" class="small">Processing <span id="fileCount">0</span> file(s) securely</div>
  </div>
</div>

<div class="footer">
  <strong>Bill Layne Insurance Agency</strong><br>
  üìç 1283 N Bridge St, Elkin, NC 28621<br>
  üìû 336-835-1993 ‚Ä¢ <a href="https://www.BillLayneInsurance.com" target="_blank">www.BillLayneInsurance.com</a><br>
  <div style="margin-top:1rem; font-size:0.8rem; opacity:0.8">
    ¬© 2024 Bill Layne Insurance ‚Ä¢ All uploads are secure and confidential
  </div>
</div>

<script>
// ============= YOUR EXACT SAME JAVASCRIPT WITH FIXED renderFiles =============
// Your deployed Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycbwfSB6SG_fiZ3R81FUU1qmBEjER0ydXwxXYkVDp-bbLzxjGPywgSdcU4p0MnrfAQYb42g/exec";

let CASE_ID = "";
let REQUIREMENTS = [];
let REQ_STATUS = {};
let selectedFiles = [];
let uploadedCount = 0;

/* --- helpers --- */
function el(id){return document.getElementById(id)}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function showModal(){ el("uploadModal").style.display = "flex"; }
function hideModal(){ el("uploadModal").style.display = "none"; }
function setModal(line, pct, count){ 
  el("modalLine").textContent = line; 
  el("modalBar").style.width = `${Math.max(0, Math.min(100, pct))}%`;
  if(count !== undefined) el("fileCount").textContent = count;
}

/* File size formatter */
function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

/* Convert file to base64 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      // Remove the data:type;base64, prefix
      const base64String = reader.result.split(',')[1];
      resolve(base64String);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* --- File Selection Management --- */
function updateFilePreview() {
  const previewArea = el("filePreviewArea");
  previewArea.innerHTML = "";
  
  if (selectedFiles.length === 0) {
    el("btnUpload").disabled = true;
    el("btnUpload").textContent = "Upload Selected Files";
    return;
  }
  
  el("btnUpload").disabled = false;
  el("btnUpload").textContent = `Upload ${selectedFiles.length} File(s)`;
  
  selectedFiles.forEach((file, index) => {
    const preview = document.createElement("div");
    preview.className = "file-preview";
    preview.innerHTML = `
      <span class="name">${esc(file.name)}</span>
      <span class="size">${formatBytes(file.size)}</span>
      <button class="remove" data-index="${index}">Remove</button>
    `;
    previewArea.appendChild(preview);
  });
  
  // Add remove handlers
  previewArea.querySelectorAll(".remove").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const idx = parseInt(e.target.dataset.index);
      selectedFiles.splice(idx, 1);
      updateFilePreview();
    });
  });
}

function handleFileSelection(files) {
  const maxSize = 10 * 1024 * 1024; // 10MB
  let errorMsg = "";
  
  Array.from(files).forEach(file => {
    if (file.size > maxSize) {
      errorMsg += `${file.name} is too large (max 10MB)<br>`;
      return;
    }
    // Avoid duplicates
    if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
      selectedFiles.push(file);
    }
  });
  
  if (errorMsg) {
    el("filesMsg").innerHTML = `<span class="error">${errorMsg}</span>`;
  }
  
  updateFilePreview();
}

/* --- UI Rendering --- */
function renderCase(d){
  CASE_ID = d.caseId;
  REQUIREMENTS = d.requirements || [];
  REQ_STATUS = d.reqStatus || {};
  uploadedCount = (d.files || []).length;

  el("caseCard").style.display = "";
  el("needCard").style.display = "";
  el("uploadCard").style.display = "";

  el("who").innerHTML = `${esc(d.name||"Customer")} ‚Ä¢ ${esc(d.product||"")} ${d.company?("‚Ä¢ "+esc(d.company)):""} ‚Ä¢ Case <strong>${esc(CASE_ID)}</strong>`;
  el("status").textContent = d.status || "Pending";
  el("status").className = d.status==="Complete" ? "ok" : "pending";

  const tags = REQUIREMENTS.map(r=>`<span class="pill">${REQ_STATUS[r.key]===true?"‚úÖ ":"‚è≥ "}${esc(r.label)}</span>`).join("");
  el("tags").innerHTML = tags;

  const outstanding = REQUIREMENTS.filter(r => REQ_STATUS[r.key]!==true);
  el("needList").innerHTML = outstanding.length ? 
    outstanding.map(r=>`<span class="pill">${esc(r.label)}</span>`).join("") : 
    `<span class="ok">You're all set ‚Äî nothing outstanding!</span>`;

  renderFiles(d.files||[]);
}

// FIXED renderFiles function with better URL handling
function renderFiles(files){
  console.log("Customer page - Files received:", files); // Debug log
  
  if (!files || !files.length) {
    el("filesList").innerHTML = `<span class="muted">No files uploaded yet.</span>`;
    return;
  }
  
  const fileLinks = files.map(f => {
    console.log("Customer page - File object:", f); // Debug each file
    
    // Check if URL exists and create appropriate link
    if (f.url) {
      return `<a class="pill" href="${f.url}" target="_blank" rel="noopener">üìÑ ${esc(f.name)}</a>`;
    } else if (f.id) {
      // If no URL but has ID, construct Google Drive URL
      const driveUrl = `https://drive.google.com/file/d/${f.id}/view`;
      return `<a class="pill" href="${driveUrl}" target="_blank" rel="noopener">üìÑ ${esc(f.name)}</a>`;
    } else if (f.webViewLink) {
      // Another possible property from Google Drive API
      return `<a class="pill" href="${f.webViewLink}" target="_blank" rel="noopener">üìÑ ${esc(f.name)}</a>`;
    } else {
      // No link available
      return `<span class="pill" style="opacity: 0.7;">üìÑ ${esc(f.name)} (processing...)</span>`;
    }
  }).join("");
  
  el("filesList").innerHTML = fileLinks;
}

/* --- Actions --- */
async function openById(){
  const id = el("caseId").value.trim();
  if(!id){ el("findMsg").textContent = "Enter your Case ID."; return; }
  el("findMsg").textContent = "Loading‚Ä¶";
  
  try {
    const fd = new FormData();
    fd.append('action', 'loadById');
    fd.append('caseId', id);
    
    const response = await fetch(API_URL, { method: 'POST', body: fd });
    const r = await response.json();
    
    if(!r.ok){ 
      el("findMsg").textContent = "Case not found."; 
      return; 
    }
    
    renderCase(r);
    el("findMsg").textContent = "Case loaded.";
    history.replaceState(null, "", location.pathname + "#case="+encodeURIComponent(id));
  } catch (err) {
    el("findMsg").textContent = "Error loading case: " + err.message;
  }
}

async function openByEmail(){
  const email = el("email").value.trim();
  if(!email){ el("findMsg").textContent = "Enter your email."; return; }
  el("findMsg").textContent = "Searching‚Ä¶";
  
  try {
    const fd = new FormData();
    fd.append('action', 'loadByEmail');
    fd.append('email', email);
    
    const response = await fetch(API_URL, { method: 'POST', body: fd });
    const r = await response.json();
    
    if(!r.ok){ 
      el("findMsg").textContent = "No case found for that email."; 
      return; 
    }
    
    renderCase(r);
    el("findMsg").textContent = "Case loaded.";
    history.replaceState(null, "", location.pathname + "#email="+encodeURIComponent(email));
  } catch (err) {
    el("findMsg").textContent = "Error searching: " + err.message;
  }
}

/* --- WORKING Base64 Upload Method --- */
async function uploadFiles(){
  if(!CASE_ID){ 
    el("filesMsg").textContent = "Open your case first."; 
    return; 
  }
  
  if (!selectedFiles.length){ 
    el("filesMsg").textContent = "Select files to upload first."; 
    return; 
  }

  showModal();
  setModal("Preparing upload...", 10, selectedFiles.length);
  el("filesMsg").textContent = "Uploading‚Ä¶ please wait";

  let successCount = 0;
  let failedFiles = [];

  try {
    // Upload each file individually as base64
    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      setModal(`Uploading ${file.name}...`, 20 + (i / selectedFiles.length * 60), selectedFiles.length);
      
      try {
        // Convert to base64
        const base64 = await fileToBase64(file);
        
        // Send as FormData with base64
        const fd = new FormData();
        fd.append('action', 'upload');
        fd.append('caseId', CASE_ID);
        fd.append('file', base64);
        fd.append('file.name', file.name);
        fd.append('file.contentType', file.type || 'application/octet-stream');
        
        const response = await fetch(API_URL, { method: 'POST', body: fd });
        const data = await response.json();
        
        if (data.ok) {
          successCount++;
        } else {
          failedFiles.push(file.name);
          console.error(`Failed to upload ${file.name}:`, data.error);
        }
      } catch (err) {
        failedFiles.push(file.name);
        console.error(`Error uploading ${file.name}:`, err);
      }
    }
    
    // Show results
    setModal("Upload complete!", 100, selectedFiles.length);
    
    if (successCount === selectedFiles.length) {
      el("filesMsg").innerHTML = `<div class="success-msg">All ${successCount} file(s) uploaded successfully!</div>`;
    } else if (successCount > 0) {
      el("filesMsg").innerHTML = `<div class="success-msg">‚úÖ ${successCount} file(s) uploaded. ‚ùå ${failedFiles.length} failed: ${failedFiles.join(', ')}</div>`;
    } else {
      el("filesMsg").innerHTML = `<div class="error">Upload failed. Please try again.</div>`;
    }
    
    // Clear selection if successful
    if (successCount > 0) {
      selectedFiles = [];
      updateFilePreview();
      el("fFiles").value = "";
      el("fCamera").value = "";
      
      // Reload case to show new files with debugging
      setTimeout(async () => {
        console.log("Customer page - Reloading files after upload...");
        const fd = new FormData();
        fd.append('action', 'loadById');
        fd.append('caseId', CASE_ID);
        
        try {
          const response = await fetch(API_URL, { method: 'POST', body: fd });
          const r = await response.json();
          console.log("Customer page - Reload response:", r);
          if (r.ok) {
            renderFiles(r.files || []);
          }
        } catch (err) {
          console.error('Error reloading files:', err);
        }
      }, 1500); // Increased delay to ensure backend processing
    }
    
  } catch (err) {
    console.error("Upload error:", err);
    setModal("Upload error", 0, 0);
    el("filesMsg").textContent = "Upload error: " + err.message;
  } finally {
    setTimeout(hideModal, 2000);
  }
}

/* --- Deep link parsing --- */
function parseHash(){
  const h = location.hash || "";
  const mEmail = h.match(/email=([^&]+)/);
  const mCase  = h.match(/case=([^&]+)/);
  return { 
    email: mEmail ? decodeURIComponent(mEmail[1]) : "", 
    caseId: mCase ? decodeURIComponent(mCase[1]) : "" 
  };
}

/* --- Page load --- */
window.addEventListener("load", async ()=>{
  const { email, caseId } = parseHash();
  if(email){ 
    el("email").value = email; 
    await openByEmail(); 
  } else if(caseId){ 
    el("caseId").value = caseId; 
    await openById(); 
  }
});

/* --- Event Listeners --- */
el("btnFindById").addEventListener("click", openById);
el("btnFindByEmail").addEventListener("click", openByEmail);
el("btnOpenFiles").addEventListener("click", ()=> el("fFiles").click());
el("btnOpenCamera").addEventListener("click", ()=> el("fCamera").click());
el("btnUpload").addEventListener("click", uploadFiles);

// File input change handlers
el("fFiles").addEventListener("change", (e) => {
  handleFileSelection(e.target.files);
});

el("fCamera").addEventListener("change", (e) => {
  handleFileSelection(e.target.files);
});

// Enter key support
el("caseId").addEventListener("keypress", (e) => {
  if (e.key === "Enter") openById();
});

el("email").addEventListener("keypress", (e) => {
  if (e.key === "Enter") openByEmail();
});
</script>
</body>
</html>

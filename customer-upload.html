<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secure Document Upload | Bill Layne Insurance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#1a5f7a; --secondary:#457b9d; --accent:#a8dadc;
    --bg:#f8f9fa; --text:#2c3e50; --radius:12px; --shadow:0 8px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Arial,sans-serif}
  header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center;padding:18px 14px;box-shadow:var(--shadow)}
  .title{font-size:1.5rem;font-weight:700}
  .wrap{max-width:800px;margin:18px auto;padding:0 12px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  label{font-size:.9rem;margin-bottom:6px;display:block;font-weight:600}
  input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:1rem;background:#fff}
  input:focus{border-color:var(--secondary);box-shadow:0 0 0 3px rgba(69,123,157,.12);outline:none}
  .btn{border:0;border-radius:999px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn-primary{background:linear-gradient(135deg,var(--secondary),var(--primary));color:#fff}
  .btn-ghost{background:#edf2f7;color:var(--text)}
  .row{display:grid;gap:10px}
  @media(min-width:700px){ .row-2{grid-template-columns:2fr 1fr} }
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:.8rem;background:var(--accent);color:#0b3a4a;margin:3px 6px 0 0;font-weight:700}
  .muted{opacity:.75}
  .upload-box{border:1.5px dashed #c7dfe6;border-radius:12px;padding:12px;background:#fbfeff}
  .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .list{margin:8px 0;display:flex;flex-wrap:wrap;gap:6px}
  .ok{color:#0a7a3a;font-weight:700}
  .pending{color:#b45309;font-weight:700}
  .footer{padding:20px;text-align:center;color:#38505c}
  @media print {.btn,.upload-box{display:none !important} .card{box-shadow:none;border:1px solid #e5e7eb}}
</style>
</head>
<body>
<header>
  <div class="title">Secure Document Upload</div>
  <div>Bill Layne Insurance</div>
</header>

<div class="wrap">
  <!-- Find Case -->
  <section class="card">
    <h3 style="margin:4px 0 10px 0">Find Your Case</h3>
    <div class="row row-2">
      <div>
        <label>Case ID <span class="muted">(from our email)</span></label>
        <input id="caseId" placeholder="e.g., 7F3A2C91" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindById">Open</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label>Or search by your email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
      <div class="right" style="align-items:end">
        <button class="btn btn-ghost" id="btnFindByEmail">Search</button>
      </div>
    </div>
    <div id="findMsg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Case Summary -->
  <section class="card" id="caseCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Your Case</h3>
    <div id="who" class="muted"></div>
    <div id="tags" class="list"></div>
    <div style="margin-top:6px">
      <strong>Status:</strong> <span id="status" class="pending">Pending</span>
    </div>
    <div class="muted" style="margin-top:6px">Items we may still need are shown below. You can upload files securely.</div>
  </section>

  <!-- Outstanding items -->
  <section class="card" id="needCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Requested Items</h3>
    <div id="needList" class="list"></div>
  </section>

  <!-- Upload -->
  <section class="card" id="uploadCard" style="display:none">
    <h3 style="margin:4px 0 10px 0">Upload Documents</h3>
    <div class="upload-box">
      <label>Attach files (PDF, JPG, PNG)</label>
      <input id="fFiles" type="file" multiple />
      <div class="right" style="margin-top:10px">
        <button class="btn btn-primary" id="btnUpload">Upload</button>
      </div>
    </div>
    <div id="filesMsg" class="muted" style="margin-top:6px"></div>
    <div id="filesList" class="list"></div>
  </section>
</div>

<div class="footer">
  © Bill Layne Insurance • 336-835-1993 • <a href="https://www.BillLayneInsurance.com" target="_blank">BillLayneInsurance.com</a>
</div>

<script>
/* ===== CONFIG: your existing Web App URL ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby-9vCxMW1wtbKL_Q2i0TRSyFiTODCg_eTINdwC8Y55QjjL2Jm2MZSeaycfDLEXpOhjjA/exec";

/* ===== State ===== */
let CASE_ID = "";
let REQUIREMENTS = [];
let REQ_STATUS = {};
let CASE_DATA = {};

/* ===== Helpers ===== */
async function postForm(data){
  const fd = new FormData();
  Object.entries(data).forEach(([k,v])=>{
    if (v instanceof File || v instanceof Blob) fd.append(k,v);
    else if (Array.isArray(v)) fd.append(k, JSON.stringify(v));
    else fd.append(k, v ?? "");
  });
  const res = await fetch(API_URL, { method:"POST", body: fd, redirect:"follow" });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return {ok:false,error:txt.slice(0,300)}; }
}
function el(id){return document.getElementById(id)}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}

/* ===== UI ===== */
function renderCase(d){
  CASE_ID = d.caseId;
  REQUIREMENTS = d.requirements || [];
  REQ_STATUS = d.reqStatus || {};
  CASE_DATA = d;

  el("caseCard").style.display = "";
  el("needCard").style.display = "";
  el("uploadCard").style.display = "";

  el("who").innerHTML = `${esc(d.name||"Customer")} • ${esc(d.product||"")} ${d.company?("• "+esc(d.company)):""} • Case <strong>${esc(CASE_ID)}</strong>`;
  el("status").textContent = d.status || "Pending";
  el("status").className = d.status==="Complete" ? "ok" : "pending";

  // tags: show all requirements with checkmarks
  const tags = REQUIREMENTS.map(r=>{
    const ok = REQ_STATUS[r.key]===true;
    return `<span class="pill">${ok?"✅ ":"⏳ "}${esc(r.label)}</span>`;
  }).join("");
  el("tags").innerHTML = tags;

  // outstanding list (unchecked only)
  const outstanding = REQUIREMENTS.filter(r => REQ_STATUS[r.key]!==true);
  el("needList").innerHTML = outstanding.length
    ? outstanding.map(r=>`<span class="pill">${esc(r.label)}</span>`).join("")
    : `<span class="ok">You’re all set — nothing outstanding.</span>`;

  // files list (links)
  renderFiles(d.files||[]);
}
function renderFiles(files){
  if(!files.length){ el("filesList").innerHTML = `<span class="muted">No files uploaded yet.</span>`; return; }
  el("filesList").innerHTML = files.map(f=>`<a class="pill" href="${f.url}" target="_blank">${esc(f.name)}</a>`).join("");
}

/* ===== Actions ===== */
async function openById(){
  const id = el("caseId").value.trim();
  if(!id){ el("findMsg").textContent = "Enter your Case ID."; return; }
  el("findMsg").textContent = "Loading…";
  const r = await postForm({action:"loadById", caseId:id});
  if(!r.ok){ el("findMsg").textContent = "Case not found."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#case="+encodeURIComponent(id)); // keep linkable
}
async function openByEmail(){
  const email = el("email").value.trim();
  if(!email){ el("findMsg").textContent = "Enter your email."; return; }
  el("findMsg").textContent = "Searching…";
  const r = await postForm({action:"loadByEmail", email});
  if(!r.ok){ el("findMsg").textContent = "No case found for that email."; return; }
  renderCase(r);
  el("findMsg").textContent = "Case loaded.";
  history.replaceState(null, "", location.pathname + "#case="+encodeURIComponent(r.caseId));
}
async function uploadFiles(){
  if(!CASE_ID){ el("filesMsg").textContent = "Open your case first."; return; }
  const files = el("fFiles").files;
  if(!files.length){ el("filesMsg").textContent = "Choose files to upload."; return; }
  el("filesMsg").textContent = "Uploading…";
  const fd = new FormData();
  fd.append("action","upload");
  fd.append("caseId", CASE_ID);
  for(const f of files) fd.append("files", f, f.name);
  const res = await fetch(API_URL, { method:"POST", body: fd });
  const txt = await res.text();
  let json; try{ json = JSON.parse(txt);}catch{ json={ok:false,error:txt}; }
  if(!json.ok){ el("filesMsg").textContent = "Upload failed."; return; }
  el("filesMsg").textContent = "Uploaded successfully.";
  renderFiles(json.files||[]);
  el("fFiles").value = "";
}

/* ===== Deep link by hash ===== */
window.addEventListener("load", async ()=>{
  const m = location.hash.match(/case=([^&]+)/);
  if(m){ el("caseId").value = decodeURIComponent(m[1]); openById(); }
});

/* ===== Events ===== */
el("btnFindById").addEventListener("click", openById);
el("btnFindByEmail").addEventListener("click", openByEmail);
el("btnUpload").addEventListener("click", uploadFiles);
</script>
</body>
</html>
